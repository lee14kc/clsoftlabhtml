<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>급여 항목 관리</title>

	<link rel="shortcut icon" href="/assets/img/favicon.png" type="image/x-icon">
	<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="/assets/plugins/tabler-icons/tabler-icons.min.css">
	<link rel="stylesheet" href="/assets/plugins/fontawesome/css/fontawesome.min.css">
	<link rel="stylesheet" href="/assets/plugins/fontawesome/css/all.min.css">
	<link rel="stylesheet" href="/assets/css/dataTables.bootstrap5.min.css">
	<link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
	<div id="global-loader">
		<div class="page-loader"></div>
	</div>

	<div class="main-wrapper">

		<div class="header">
			<div class="main-header">
				<div class="header-left">
					<a href="/" class="logo">
						<img src="/assets/img/logo.svg" alt="Logo">
					</a>
				</div>
				<a id="toggle_btn" href="javascript:void(0);" class="btn btn-menubar me-1">
					<i class="ti ti-arrow-bar-to-left"></i>
				</a>
				<a id="mobile_btn" class="mobile_btn" href="#sidebar">
					<span class="bar-icon"><span></span><span></span><span></span></span>
				</a>
			</div>
		</div>
		<div th:replace= "~{common/sidebar :: sidebar}" >
		</div>
		<div class="page-wrapper">
			<div class="content">

				<div class="card">
					<div class="card-header">
						<h5 class="card-title">검색 조건</h5>
					</div>
					<div class="card-body">
						<div id="pay-item-search-box">
							<form action="/pay/pay-item" method="get">
								<div class="row">
									<div class="col-md-3">
										<div class="form-group">
											<label>항목명</label>
											<input type="text" class="form-control" placeholder="항목명 검색" name="itemName">
										</div>
									</div>
									<div class="col-md-3">
										<div class="form-group">
											<label>항목 유형</label>
											<select class="form-select" name="itemType">
												<option value="" >전체</option>
												<option value="PAY" th:selected="${itemType} == PAY">PAY</option>
												<option value="DEDUCT" th:selected="${itemType} == DEDUCT">DEDUCT</option>
												<option value="TAX" th:selected="${itemType} == TAX">TAX</option>
												<option value="INSURANCE" th:selected="${itemType} == INSURANCE">INSURANCE</option>
												<option value="BACKPAY" th:selected="${itemType} == BACKPAY">BACKPAY</option>
											</select>
										</div>
									</div>
									<div class="col-md-3">
										<div class="form-group">
											<label>사용 여부</label>
											<select class="form-select" name="useYn">
												<option value="">전체</option>
												<option value="Y" th:selected="${useYn == 'Y'} ">Y</option>
												<option value="N" th:selected="${useYn == 'N'}">N</option>
											</select>
										</div>
									</div>
									<div class="col-md-3 d-flex align-items-end">
										<div class="form-group w-100">
											<button type="submit" class="btn btn-primary w-100">조회</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>

				<div class="card">
					<div class="card-header">
						<h5 class="card-title">항목 목록</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-striped table-hover datatable">
								<thead class="table-light">
									<tr>
										<th>항목코드</th>
										<th>항목명</th>
										<th>유형</th>
										<th>과세</th>
										<th>절사방식</th>
										<th>사용여부</th>
										<th>수정</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each= "z : ${payItem}">
										<td th:text="${z.itemCode}"></td>
										<td th:text="${z.itemName}"></td>
										<td th:text="${z.itemType}"></td>
										<td th:text="${z.taxYn}"></td>
										<td th:text="${z.roundType}"></td>
										<td th:text="${z.useYn}"></td>
										<td><button class="btn btn-primary edit-btn"  data-bs-toggle="modal" data-bs-target="#editModal" th:data-value="${z.itemCode}">수정</button></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-xl modal-dialog-centered">
				        <div class="modal-content">
				            <div class="modal-header">
				                <h5 class="modal-title" id="addModalLabel">신규 항목 등록</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				            </div>
				            <div class="modal-body">
				                <form id="addPayItem">
				                    <div class="row">
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>항목코드</label>
				                                <input type="text" class="form-control" name="itemCode" required="required" maxlength="20">
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>항목명</label>
				                                <input type="text" class="form-control" name="itemName" required="required" maxlength="100">
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>유형</label>
				                                <select class="form-select" name="itemType">
				                                    <option value="PAY">PAY</option>
				                                    <option value="DEDUCT">DEDUCT</option>
				                                    <option value="INSURANCE">INSURANCE</option>
				                                    <option value="TAX">TAX</option>
				                                    <option value="BACKPAY">BACKPAY</option>
				                                </select>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>과세여부</label>
				                                <div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="Y" checked name="taxYn">
				                                        <label class="form-check-label">Y (과세)</label>
				                                    </div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="N" name="taxYn">
				                                        <label class="form-check-label">N (비과세)</label>
				                                    </div>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>과세방식</label>
				                                <select class="form-select" name="taxType" onchange="checkTaxType(this)">
				                                    <option value="">선택...</option>
				                                    <option value="PERCENT">PERCENT</option>
				                                    <option value="AMOUNT">AMOUNT</option>
				                                </select>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>과세비율</label>
				                                <input type="number" step="0.01" class="form-control" min="0" max="999.99" name="taxPercent">
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>절사방식</label>
				                                <select class="form-select" name="roundType">
				                                    <option value="WON">WON</option>
				                                    <option value="TEN">TEN</option>
				                                    <option value="HUNDRED">HUNDRED</option>
				                                </select>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>소급여부</label>
				                                <div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="Y" name="backPayYn">
				                                        <label class="form-check-label">Y</label>
				                                    </div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="N" checked name="backPayYn">
				                                        <label class="form-check-label">N</label>
				                                    </div>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>4대보험 대상여부</label>
				                                <div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="Y" checked name="insuranceYn">
				                                        <label class="form-check-label">Y</label>
				                                    </div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="N" name="insuranceYn">
				                                        <label class="form-check-label">N</label>
				                                    </div>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>사용여부</label>
				                                <div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="Y" checked name="useYn">
				                                        <label class="form-check-label">Y</label>
				                                    </div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="N" name="useYn">
				                                        <label class="form-check-label">N</label>
				                                    </div>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-8 mb-3">
				                            <div class="form-group">
				                                <label>비고</label>
				                                <textarea class="form-control" rows="2" name="note" maxlength="500"></textarea>
				                            </div>
				                        </div>
				                    </div>
				                    </form>
				            </div>
				            <div class="modal-footer gap-2">
				                <button type="reset" form="addPayItem" class="btn btn-outline-secondary">
				                    <i class="fas fa-redo-alt me-1"></i> 초기화
				                </button>
				                <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">취소</button>
				                <button type="button" class="btn btn-primary" onclick="addNewPayItem()">저장</button>
				            </div>
				        </div>
				    </div>
				</div>
				<div class="my-3 text-end">
					<button type="button" id="addButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">신규 등록</button>
				</div>
				<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-xl modal-dialog-centered">
				        <div class="modal-content">
				            <div class="modal-header">
				                <h5 class="modal-title" id="editModalLabel">항목 정보 수정</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				            </div>
				            <div class="modal-body">
				                <form id="editPayItemForm">
				                    <div class="row">
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>항목코드</label>
				                                <input type="text" class="form-control" name="itemCode" readonly>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>항목명</label>
				                                <input type="text" class="form-control" name="itemName" readonly>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>유형</label>
				                                <input type="text" class="form-control" name="itemType" readonly>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>과세여부</label>
				                                <div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="Y" name="taxYn">
				                                        <label class="form-check-label">Y (과세)</label>
				                                    </div>
				                                    <div class="form-check form-check-inline">
				                                        <input class="form-check-input" type="radio" value="N" name="taxYn">
				                                        <label class="form-check-label">N (비과세)</label>
				                                    </div>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>과세방식</label>
				                                <select class="form-select" name="taxType" onchange="checkTaxType(this)">
				                                    <option value="">선택...</option>
				                                    <option value="PERCENT">PERCENT</option>
				                                    <option value="AMOUNT">AMOUNT</option>
				                                </select>
				                            </div>
				                        </div>
				                        <div class="col-md-4 mb-3">
				                            <div class="form-group">
				                                <label>과세비율</label>
				                                <input type="number" step="0.01" class="form-control" min="0" max="999.99" name="taxPercent">
				                            </div>
				                        </div>
   										<div class="col-md-4 mb-3">
											<div class="form-group">
												<label>절사방식</label>
												<select class="form-select" name="roundType">
													<option value="WON">WON</option>
													<option value="TEN">TEN</option>
													<option value="HUNDRED">HUNDRED</option>
												</select>
											</div>
										</div>
										<div class="col-md-4 mb-3">
											<div class="form-group">
												<label>소급여부</label>
												<div>
													<div class="form-check form-check-inline">
														<input class="form-check-input" type="radio"  value="Y" name="backPayYn">
														<label class="form-check-label" for="backY">Y</label>
													</div>
													<div class="form-check form-check-inline">
														<input class="form-check-input" type="radio"  value="N" checked name="backPayYn">
														<label class="form-check-label" for="backN">N</label>
													</div>
												</div>
											</div>
										</div>
										<div class="col-md-4 mb-3">
											<div class="form-group">
												<label>4대보험 대상여부</label>
												<div>
													<div class="form-check form-check-inline">
														<input class="form-check-input" type="radio"  value="Y" checked name="insuranceYn">
														<label class="form-check-label" for="insrY">Y</label>
													</div>
													<div class="form-check form-check-inline">
														<input class="form-check-input" type="radio"  value="N" name="insuranceYn">
														<label class="form-check-label" for="insrN">N</label>
													</div>
												</div>
											</div>
										</div>
				                        </div>
				                        <div class="col-md-4 mb-3">
										<div class="form-group">
											<label>사용여부</label>
											<div>
												<div class="form-check form-check-inline">
													<input class="form-check-input" type="radio" value="Y" checked name="useYn">
													<label class="form-check-label" for="useY">Y</label>
												</div>
												<div class="form-check form-check-inline">
													<input class="form-check-input" type="radio"  value="N" name="useYn">
													<label class="form-check-label" for="useN">N</label>
												</div>
											</div>
											</div>
										</div>
										<div class="col-md-8 mb-3">
											<div class="form-group">
												<label>비고</label>
												<textarea class="form-control" rows="2" name="note" maxlength="500"></textarea>
											</div>
										</div>
				                </form>
				                </div>
				            <div class="modal-footer gap-2">
				                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
				                <button type="button" class="btn btn-primary" onclick="updatePayItem()">변경사항 저장</button>
				            </div>
				        </div>
				    </div>
				</div>				
			</div>

			<div th:replace= "~{common/footer :: footer}" >
			</div>
		</div>
	</div>
	<script src="/assets/js/jquery-3.7.1.min.js"></script>
	<script src="/assets/js/bootstrap.bundle.min.js"></script>
	<script src="/assets/js/jquery.slimscroll.min.js"></script>
	<script src="https://unpkg.com/feather-icons"></script>
	<script src="/assets/js/jquery.dataTables.min.js"></script>
	<script src="/assets/js/dataTables.bootstrap5.min.js"></script>
	<script src="/assets/js/script.js"></script>
	<script type="text/javascript">
	
	const addPayItemForm = document.getElementById('addPayItem');
		
			async function addNewPayItem() {
		    const formData = new FormData(addPayItemForm);
		    const data = Object.fromEntries(formData.entries());

		    //  항목코드 형식 검사 (영어/숫자) ---
		    const regex = /^[a-zA-Z0-9]+$/;
		    if (!regex.test(data.itemCode)) {
		        alert('항목코드는 영어와 숫자로만 구성해야 합니다.');
		        document.querySelector('[name="itemCode"]').focus();
		        return;
		    }
		    
		    // 항목명 공백 검사
		    if (!data.itemName || !data.itemName.trim()) {
		        alert('항목명을 반드시 입력해야 합니다.');
		        document.querySelector('#addPayItem [name="itemName"]').focus();
		        return;
		    }

		    // 과세여부가 Y인 경우 과세방식 체크
		    if (data.taxYn === 'Y' && !data.taxType) {
		        alert('과세여부가 Y인 경우, 과세방식을 반드시 선택해야 합니다.');
		        document.querySelector('[name="taxType"]').focus();
		        return;
		    }
		    // (onchange에서 처리하지만) 최종 저장 전 한번 더 확인 ---
		    if (data.taxType === 'PERCENT' && !data.taxPercent) {
		        alert('과세방식이 PERCENT인 경우, 과세비율을 반드시 입력해야 합니다.');
		        document.querySelector('[name="taxPercent"]').focus();
		        return;
		    }
		    
		    
		    // --- 서버 작업 시작 ---
		    try {
		        const response = await fetch(`/pay/pay-item/detail/${data.itemCode}`);
		        
		        if (response.ok) {
		            alert('이미 사용 중인 항목코드입니다. 다른 코드를 입력해주세요.');
		            document.querySelector('[name="itemCode"]').focus();
		            return;
		        }

		        // --- 모든 검사를 통과하면 최종 저장 (POST) ---
		        const saveResponse = await fetch('/pay/pay-item', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		            },
		            body: JSON.stringify(data),
		        });

		        if (saveResponse.ok) {
		            alert('성공적으로 등록되었습니다.');
		            location.reload();
		        } else {
		            const errorText = await saveResponse.text();
		            alert(`등록에 실패했습니다: ${errorText}`);
		        }

		    } catch (error) {
		        console.error('Error:', error);
		        alert('등록 중 오류가 발생했습니다.');
		    }
		}
		
		
		// 과세방식이 Percent면, 과세비율을 required로 변경.
		function checkTaxType(selectElement) {
			
		    const parentForm = selectElement.closest('form');
		    const taxPercentInput = parentForm.querySelector('[name="taxPercent"]');

		    if (selectElement.value === 'PERCENT') {
		        taxPercentInput.required = true;
		    } else {
		        taxPercentInput.required = false;
		        taxPercentInput.value = ''; 
		    }
		}
		
		
		//
		document.addEventListener('DOMContentLoaded', function() {
		    const tableBody = document.querySelector('.datatable tbody');
		
		    if (tableBody) {
		        tableBody.addEventListener('click', function(event) {
		        	
		            const editButton = event.target.closest('.edit-btn');
		
		            
		            if (editButton) {
		                const itemCode = editButton.dataset.value; 
		                findPayItemDetail(itemCode);
		            }
		        });
		    }
		});
		
		async function findPayItemDetail(itemCode) {
		    try {
		        const response = await fetch(`/pay/pay-item/detail/${itemCode}`);
		        if (!response.ok) {
		            throw new Error('데이터를 불러오는 데 실패했습니다.');
		        }
		        const data = await response.json();

		        const editForm = document.getElementById('editPayItemForm');

		        for (const key in data) {
		            const field = editForm.querySelector(`[name="${key}"]`);
		            if (field) {
		                if (field.type === 'radio') {
		                    // 라디오 버튼의 경우, 값(value)이 일치하는 것을 찾아 체크합니다.
		                    editForm.querySelector(`[name="${key}"][value="${data[key]}"]`).checked = true;
		                } else {
		                    field.value = data[key];
		                }
		            }
		        }
		        
		        // 과세방식(taxType)의 onchange 이벤트를 수동으로 한번 실행시켜줍니다.
		        checkTaxType(editForm.querySelector('[name="taxType"]'));

		    } catch (error) {
		        console.error('Error:', error);
		        alert(error.message);
		    }
		}
		
		//급여 항목 수정
		async function updatePayItem() {
		    const editForm = document.getElementById('editPayItemForm');
		    const formData = new FormData(editForm);
		    const data = Object.fromEntries(formData.entries());

		    // 유효성 검사 (예: 과세비율 등)
		    if (data.taxYn === 'Y' && !data.taxType) {
		        alert('과세여부가 Y인 경우, 과세방식을 반드시 선택해야 합니다.');
		        document.querySelector('[name="taxType"]').focus();
		        return;
		    }
		    
		    
		    if (data.taxType === 'PERCENT' && !data.taxPercent) {
		        alert('과세방식이 PERCENT인 경우, 과세비율을 반드시 입력해야 합니다.');
		        return;
		    }
		    
		    try {
		        const url = `/pay/pay-item/${data.itemCode}`;
		        const response = await fetch(url, {
		            method: 'PUT', 
		            headers: {
		                'Content-Type': 'application/json',
		            },
		            body: JSON.stringify(data),
		        });

		        if (response.ok) {
		            alert('성공적으로 수정되었습니다.');
		            location.reload(); // 성공 시 페이지 새로고침
		        } else {
		            const errorText = await response.text();
		            alert(`수정에 실패했습니다: ${errorText}`);
		        }
		    } catch (error) {
		        console.error('Error:', error);
		        alert('수정 중 오류가 발생했습니다.');
		    }
		}

	
	</script>
	

</body>

</html>